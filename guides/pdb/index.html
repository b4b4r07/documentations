<!doctype html><html lang=ja class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="Personal documentations about what I learn"><link href=https://b4b4r07.github.io/docs/guides/pdb/ rel=canonical><meta name=author content="Masaki ISHIYAMA"><meta name=lang:clipboard.copy content=クリップボードへコピー><meta name=lang:clipboard.copied content=コピーしました><meta name=lang:search.language content=ja><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content=何も見つかりませんでした><meta name=lang:search.result.one content=1件見つかりました><meta name=lang:search.result.other content=#件見つかりました><meta name=lang:search.tokenizer content=[\s\-　、。，．]+><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>Pdb - Documentations</title><link rel=stylesheet href=../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#546e7a><script src=../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css></head> <body dir=ltr data-md-color-primary=blue-grey data-md-color-accent=blue-grey> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#tldr tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://b4b4r07.github.io/docs/ title=Documentations class="md-header-nav__button md-logo"> <i class=md-icon></i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Documentations </span> <span class=md-header-nav__topic> Pdb </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=検索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> 検索キーワードを入力してください </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/b4b4r07/docs/ title=リポジトリへ class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> b4b4r07/docs </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://b4b4r07.github.io/docs/ title=Documentations class="md-nav__button md-logo"> <i class=md-icon></i> </a> Documentations </label> <div class=md-nav__source> <a href=https://github.com/b4b4r07/docs/ title=リポジトリへ class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> b4b4r07/docs </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <label class=md-nav__link for=nav-1> Concepts </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-1> Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-1-1 type=checkbox id=nav-1-1> <label class=md-nav__link for=nav-1-1> Kubernetes </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-1-1> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../concepts/kubernetes/components/ title=Conponents class=md-nav__link> Conponents </a> </li> <li class=md-nav__item> <a href=../../concepts/kubernetes/helm/ title=Helm class=md-nav__link> Helm </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Guides </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Guides </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../docs/guides/when-to-use-google-kubernetes-engine-vs-cloud-run-for-containers.md title="GKE と Cloud Run、どう使い分けるべきか" class=md-nav__link> GKE と Cloud Run、どう使い分けるべきか </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> References </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> References </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../references/kubernetes/ title=Kubernetes class=md-nav__link> Kubernetes </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目次</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#tldr class=md-nav__link> TL;DR </a> </li> <li class=md-nav__item> <a href=#node-pod-kubectl-drain class=md-nav__link> Node から Pod を退去させる (kubectl drain) </a> </li> <li class=md-nav__item> <a href=#kubectl-drain class=md-nav__link> kubectl drain の動作 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 動作例 </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 注意が必要な場合 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#poddisruptionbudget-drain class=md-nav__link> PodDisruptionBudget による安全な drain </a> </li> <li class=md-nav__item> <a href=#poddisruptionbudget class=md-nav__link> PodDisruptionBudget の状況を見る </a> </li> <li class=md-nav__item> <a href=#eviction-api class=md-nav__link> 補足: Eviction (退避) API </a> </li> <li class=md-nav__item> <a href=#poddisruptionbudget_1 class=md-nav__link> PodDisruptionBudget の動作を試してみる </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 参考 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/b4b4r07/docs/edit/master/docs/guides/pdb.md title=編集 class="md-icon md-content__icon">&#xE3C9;</a> <h1>Pdb</h1> <p>OS のアップデートやスケールダウンなどで複数の Node を安全に停止したい場合のメモです。この記事は Kubernetes 1.7.3 で確認した情報を元に記載しています。</p> <h2 id=tldr>TL;DR<a class=headerlink href=#tldr title="Permanent link">#</a></h2> <ul> <li>Node を停止するためにはkubectl drain <node> コマンドを利用して停止準備を行います</li> <li>drain は Node を Pod のスケジュール対象から外し (unschedulable に設定) Node 上の Pod を退去させることで停止可能な状態にします</li> <li>しかし複数の Node を停止させる場合、アプリケーションの Pod が一つも動作していない状態 (ready な Pod が 0)がありえるので注意が必要です <img alt=😨 class=emojione src=https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f628.svg title=:fearful:> </li> <li><code class=codehilite>PodDisruptionBudget</code> を定義することで安全な Pod 数を保ったまま複数 Node の drain を行うことができるようになります <img alt=😃 class=emojione src=https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f603.svg title=:smiley:> </li> <li>安全な Pod 数が確保できるまで <code class=codehilite>kubectl drain</code> が Pod の退去を待ってくれるようになります</li> </ul> <h2 id=node-pod-kubectl-drain>Node から Pod を退去させる (kubectl drain)<a class=headerlink href=#node-pod-kubectl-drain title="Permanent link">#</a></h2> <p>OS のアップデートやスケールダウンなどで Node を停止したい場合、その Node にスケジュールされている Pod に退去してもらう必要があります。この操作は <code class=codehilite>kubctl drain &lt;NODE&gt;</code> というコマンドで簡単に行うことができます。</p> <p>下記のように Node 名を指定して <code class=codehilite>kubectl drain</code> を実行します。</p> <div class=codehilite><pre><span></span>$ kubectl drain --ignore-daemonsets --force gke-cluster-2-default-pool-0fb8a591-71rf
<span class=c1># Node が unschedulable に設定される (kubectl cordon と同等)</span>
node <span class=s2>&quot;gke-cluster-2-default-pool-0fb8a591-71rf&quot;</span> cordoned
WARNING: Deleting pods not managed by ReplicationController, ReplicaSet, Job, DaemonSet or StatefulSet: kube-proxy-gke-cluster-2-default-pool-0fb8a591-71rf<span class=p>;</span> Ignoring DaemonSet-managed pods: fluentd-gcp-v2.0-tt6mf
<span class=c1># この Node にある Pod が退去させられていく</span>
pod <span class=s2>&quot;myapp-1243928920-bz02h&quot;</span> evicted
pod <span class=s2>&quot;heapster-v1.4.0-1718439912-xmg0k&quot;</span> evicted
<span class=c1># drain が完了</span>
node <span class=s2>&quot;gke-cluster-2-default-pool-0fb8a591-71rf&quot;</span> drained
</pre></div> <p>ノードが正しく SchedulingDisabled (unschedulable) になっていることを確認します。動作中の Pod がなくなり、新たに Pod がスケジュールされることもないため、このノードは停止することができます。</p> <div class=codehilite><pre><span></span>$ kubectl get nodes
NAME                                       STATUS                     AGE       VERSION
gke-cluster-2-default-pool-0fb8a591-71rf   Ready,SchedulingDisabled   20m       v1.7.3 <span class=c1># SchedulingDisabled になった</span>
gke-cluster-2-default-pool-0fb8a591-cmcl   Ready                      20m       v1.7.3
gke-cluster-2-default-pool-0fb8a591-d6pn   Ready                      20m       v1.7.3
gke-cluster-2-default-pool-0fb8a591-n1sr   Ready                      20m       v1.7.3
</pre></div> <h2 id=kubectl-drain>kubectl drain の動作<a class=headerlink href=#kubectl-drain title="Permanent link">#</a></h2> <p><code class=codehilite>kubectl drain</code> では主に以下の処理が行われています。</p> <ul> <li>Node に新規 Pod がスケジュールされないように <code class=codehilite>unschedulable</code> の設定を行う</li> <li>Node に紐付けられている Pod 一覧を取得して、Pod 群に退去 (evict) の処理が行われる</li> <li>詳しくは後述の Eviction API をご覧ください</li> <li>evict がサポートされない場合(旧バージョンの API Server など)は単に削除処理になる</li> </ul> <h3 id=_1>動作例<a class=headerlink href=#_1 title="Permanent link">#</a></h3> <p>例えば Node が 4台あり、以下のように <code class=codehilite>myapp</code> というアプリケーションが 2 つのノードにある状態だとします。myapp は ReplicaSet (レプリカ数 2) で管理されているとします。</p> <p><img alt=image.png src=https://qiita-image-store.s3.amazonaws.com/0/100377/895dce05-15d7-a43d-6a32-29c23b8a1025.png></p> <p>node-1 に対して <code class=codehilite>kubectl drain</code> を行うと、下記のような順序で処理が行われます。</p> <ol> <li>node-1 を <code class=codehilite>unschedulrable</code> に設定</li> <li>node-1 に割り当てられた Pod (ここでは myapp-1) が退去(evict)させられます</li> <li>PodDisruptionBudget が設定されていない場合、退去(evict) は単純に Pod が削除されます</li> <li>kubectl の drain はここで終了します</li> <li>ReplicaSet の働きによって node-3 に新たに Pod が作成され、レプリカ数 2 が保たれます。</li> </ol> <p><img alt=image.png src=https://qiita-image-store.s3.amazonaws.com/0/100377/cea9b8c0-fdcc-2ce0-2abc-7df1d1b3497f.png></p> <h3 id=_2><img alt=⚠️ class=emojione src=https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/26a0.svg title=:warning:> 注意が必要な場合<a class=headerlink href=#_2 title="Permanent link">#</a></h3> <p>続けて node-2 を drain したい場合注意が必要です。新しく作成された myapp-3 の Pod 作成に時間がかかった場合は、node-2 を drain することによって一つも Pod が ready になっていない状況が起こり得ます。</p> <p><img alt=image.png src=https://qiita-image-store.s3.amazonaws.com/0/100377/7199eb1d-f1ed-b9dc-e867-61b3e1a7c556.png></p> <h2 id=poddisruptionbudget-drain>PodDisruptionBudget による安全な drain<a class=headerlink href=#poddisruptionbudget-drain title="Permanent link">#</a></h2> <p>PodDisruptionBudget とは Node を計画的に停止したい場合に、Pod の状況を見ながら退去 (evict) させる機能です。基本的にアプリケーションは ReplicaSet によって複数の Pod が保持されているため冗長性があると考えられます。PodDisruptionBudget は停止状態 (Disruption) として許容できる Pod 数を予算 (Budget) として定義して、その予算内で退去させていきます。(<a href=https://landing.google.com/sre/book/chapters/embracing-risk.html#xref_risk-management_unreliability-budgets>Error Budget</a> 的な名前で洒落ていますね)。</p> <p>PodDiruptionBudget では以下のどちらかの設定が可能です。</p> <ul> <li><code class=codehilite><span class=na>.spec.minAvailable</span></code>: 少なくとも有効であるべき Pod 数。パーセンテージによる指定も可能</li> <li><code class=codehilite><span class=na>.spec.maxUnavailable</span></code>: 最大無効であってもよい Pod 数。パーセンテージによる指定も可能 (v1.7 以上で利用可能)</li> </ul> <p>以下のように <code class=codehilite>PodDisruptionBudget</code> リソースを定義して利用します。<code class=codehilite>kubectl create poddisruptionbudget</code> というサブコマンドによる作成も可能です。</p> <div class=codehilite><pre><span></span><span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">policy/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">PodDisruptionBudget</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=c1># 最大で無効状態な Pod は 1 に設定。これを超えては退去させられない</span>
  <span class=nt>maxUnavailable</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class=c1># 対象 Pod のセレクタ</span>
  <span class=nt>selector</span><span class=p>:</span>
    <span class=nt>matchLabels</span><span class=p>:</span>
      <span class=nt>run</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">myapp</span>
</pre></div> <p>これを設定すると前述の例の Node-2 の退去は以下の動作になります。</p> <ol> <li>node-2 を unschedulrable に設定</li> <li>node-2 に割り当てられた Pod (ここでは myapp-1) を退去(evict)しようとする</li> <li>すでに unavailable の Pod があり PodDisruptionBudget を超えてしまうため退去を待ちます (5 秒間隔でリトライ)</li> </ol> <p><img alt=image.png src=https://qiita-image-store.s3.amazonaws.com/0/100377/42042d6d-7365-ec7d-532e-02cd3c334892.png></p> <p>node-3 の Pod が ready になり PodDisruptionBudget を満たすようになると node-2 の Pod は削除されます。</p> <p><img alt=image.png src=https://qiita-image-store.s3.amazonaws.com/0/100377/7eaf76af-ce70-624d-1018-f9324d1a2f09.png></p> <h2 id=poddisruptionbudget>PodDisruptionBudget の状況を見る<a class=headerlink href=#poddisruptionbudget title="Permanent link">#</a></h2> <p>PodDisruptionBudget リソースには管理されている Pod の状態が記述されています。<code class=codehilite>kubectl get pdb</code> で設定状況と現在停止が許容される Pod 数 (<code class=codehilite>ALLOWED-DISRUPTIONS</code>) を見ることができます。</p> <div class=codehilite><pre><span></span>$ kubectl get pdb
NAME      MIN-AVAILABLE   MAX-UNAVAILABLE   ALLOWED-DISRUPTIONS   AGE
myapp     N/A             <span class=m>1</span>                 <span class=m>1</span>                     2m
</pre></div> <p>詳細な状況は下記のように見ることができます。</p> <div class=codehilite><pre><span></span>$ kubectl get pdb -o yaml myapp
</pre></div> <div class=codehilite><pre><span></span><span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">policy/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">PodDisruptionBudget</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>annotations</span><span class=p>:</span>
    <span class=nt>kubectl.kubernetes.io/last-applied-configuration</span><span class=p>:</span> <span class="p p-Indicator">|</span>
      <span class=no>{&quot;apiVersion&quot;:&quot;policy/v1beta1&quot;,&quot;kind&quot;:&quot;PodDisruptionBudget&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;myapp&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;maxUnavailable&quot;:1,&quot;selector&quot;:{&quot;matchLabels&quot;:{&quot;run&quot;:&quot;myapp&quot;}}}}</span>
  <span class=nt>creationTimestamp</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">2017-08-28T07:53:13Z</span>
  <span class=nt>generation</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">myapp</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
  <span class=nt>resourceVersion</span><span class=p>:</span> <span class=s>&quot;8859&quot;</span>
  <span class=nt>selfLink</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/apis/policy/v1beta1/namespaces/default/poddisruptionbudgets/myapp</span>
  <span class=nt>uid</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">f14ed83b-8bc5-11e7-862c-42010af00125</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>maxUnavailable</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class=nt>selector</span><span class=p>:</span>
    <span class=nt>matchLabels</span><span class=p>:</span>
      <span class=nt>run</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class=nt>status</span><span class=p>:</span>
  <span class=c1># ready 状態の Pod 数</span>
  <span class=nt>currentHealthy</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
  <span class=c1># この数を下回っては Evicton できない</span>
  <span class=nt>desiredHealthy</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">9</span>
  <span class=nt>disruptedPods</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
  <span class=c1># 現在停止が許される Pod 数。currentHealthy - desiredHealthy で計算される</span>
  <span class=nt>disruptionsAllowed</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class=nt>expectedPods</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
  <span class=nt>observedGeneration</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
</pre></div> <h2 id=eviction-api>補足: Eviction (退避) API<a class=headerlink href=#eviction-api title="Permanent link">#</a></h2> <p><code class=codehilite>kubectl drain</code> では内部的には Pod の削除(DELETE)ではなく、Eviction API という Pod のサブリソースを呼び出して Node に紐づく Pod の退避を行っています。Pod の削除との違いは PodDiruptionBudget を参照し予算を満たさない場合は削除せずに <a href=https://httpstatuses.com/429>429 Too Many Requests</a> を返す点です。</p> <p>Eviction サブリソースは Pod のサブリソースとして以下のように定義されています。</p> <div class=codehilite><pre><span></span>/api/v1/namespaces/&lt;NAMESPACE&gt;/pods/&lt;POD&gt;/eviction
</pre></div> <p>この API に対して以下のような Eviction サブリソース を POST します。</p> <div class=codehilite><pre><span></span><span class=p>{</span>
  <span class=nt>&quot;kind&quot;</span><span class=p>:</span> <span class=s2>&quot;Eviction&quot;</span><span class=p>,</span>
  <span class=nt>&quot;apiVersion&quot;</span><span class=p>:</span> <span class=s2>&quot;policy/v1beta1&quot;</span><span class=p>,</span>
  <span class=nt>&quot;metadata&quot;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;myapp-1243928920-bz02h&quot;</span><span class=p>,</span> <span class=err>#</span> <span class=err>POD</span> <span class=err>名</span>
    <span class=nt>&quot;namespace&quot;</span><span class=p>:</span> <span class=s2>&quot;default&quot;</span><span class=p>,</span>
    <span class=nt>&quot;creationTimestamp&quot;</span><span class=p>:</span> <span class=kc>null</span>
  <span class=p>},</span>
  <span class=nt>&quot;deleteOptions&quot;</span><span class=p>:</span> <span class=p>{}</span>
<span class=p>}</span>
</pre></div> <p>Eviction API は PodDiruptionBudget を参照し、定義した予算を満たしている場合は Pod の削除して HTTP の <a href=https://httpstatuses.com/201>201 Created</a>、満たしていない場合は削除せず HTTP の <a href=https://httpstatuses.com/429>429 Too Many Requests</a> を返します。</p> <div class=codehilite><pre><span></span><span class=c1># kubectl の verbose ログ</span>
I0828 <span class=m>14</span>:12:38.049411   <span class=m>29825</span> round_trippers.go:405<span class=o>]</span> POST https://35.194.250.38/api/v1/namespaces/default/pods/myapp-1243928920-cpmcr/eviction <span class=m>429</span> Too Many Requests in <span class=m>39</span> milliseconds
</pre></div> <p>kubectl drain では <code class=codehilite>429 Too Many Requests</code> のときは 5 秒ごとにリトライする実装になっており、予算を満たすかタイムアウト(<code class=codehilite>--timeout</code> の値)になるまで待ち続けます。(参考: <a href=https://github.com/kubernetes/kubernetes/blob/3b2417a7f8ee8ffbfaab8cd05d5737ae0306c87b/pkg/kubectl/cmd/drain.go#L500>drain.go#L500</a>)</p> <h2 id=poddisruptionbudget_1>PodDisruptionBudget の動作を試してみる<a class=headerlink href=#poddisruptionbudget_1 title="Permanent link">#</a></h2> <p>PodDisruptionBudget を実際に試してみます。ここでは ready になるまでに時間がかかる(2分)アプリケーションをデプロイし、maxUnavailable を 1 に設定しています。(<a href=https://gist.github.com/tksm/7fa6af30b7e2fb18182351687089d975>使用した Deployment と PodDisruptionBudget のマニフェスト</a>)。下記のように Pod が 2 つの Node にデプロイされている状態から始めます。Node は全体で 4 つあります。</p> <div class=codehilite><pre><span></span>$ kubectl get pods -o wide
NAME                     READY     STATUS    RESTARTS   AGE       IP         NODE
myapp-1871887261-k5v4s   <span class=m>1</span>/1       Running   <span class=m>0</span>          2m        <span class=m>10</span>.8.0.7   gke-cluster-1-default-pool-94337df7-lnc5
myapp-1871887261-x23z5   <span class=m>1</span>/1       Running   <span class=m>0</span>          2m        <span class=m>10</span>.8.2.6   gke-cluster-1-default-pool-94337df7-sfp4
</pre></div> <p>Pod がデプロイされている 2 Node に対して同時に drain を実行してみます。</p> <div class=codehilite><pre><span></span>$ kubectl drain --ignore-daemonsets --force gke-cluster-1-default-pool-94337df7-lnc5
$ kubectl drain --ignore-daemonsets --force gke-cluster-1-default-pool-94337df7-sfp4
</pre></div> <p>ReplicaSet を watch して drain 中の Pod の状態を見てます。想定どおり PodDisruptionBudget のおかげで ready の Pod が常にある状態を保っています。Node の一つは drain がすぐに終わり、もう一つの Node は drain が PodDisruptionBudget で定義した Pod のready を待つために約 2 分間かかりました。</p> <div class=codehilite><pre><span></span><span class=c1># DESIRED : ReplicaSet で定義したレプリカ数</span>
<span class=c1># CURRENT : Pod 数 (ステータスは関係なし)</span>
<span class=c1># READY   : ready 状態の Pod 数</span>

$ kubectl get rs -w
NAME               DESIRED   CURRENT   READY     AGE
myapp-1871887261   <span class=m>2</span>         <span class=m>2</span>         <span class=m>2</span>         3m <span class=c1># drain 実行前</span>
myapp-1871887261   <span class=m>2</span>         <span class=m>1</span>         <span class=m>1</span>         3m <span class=c1># ひとつめの Node の drain によって Pod が減る</span>
myapp-1871887261   <span class=m>2</span>         <span class=m>2</span>         <span class=m>1</span>         3m <span class=c1># ReplicaSet によって Pod が増えるが ready にはならない</span>
<span class=c1># ready を待つためにここで約 2分間かかる</span>
myapp-1871887261   <span class=m>2</span>         <span class=m>2</span>         <span class=m>2</span>         5m <span class=c1># 2 つready になったので ふたつめの Node も drain できる</span>
myapp-1871887261   <span class=m>2</span>         <span class=m>1</span>         <span class=m>1</span>         5m <span class=c1># ふたつめの Node の drain によって Pod が減る</span>
myapp-1871887261   <span class=m>2</span>         <span class=m>2</span>         <span class=m>1</span>         5m <span class=c1># ReplicaSet によって Pod が増えるが ready にはならない</span>
myapp-1871887261   <span class=m>2</span>         <span class=m>2</span>         <span class=m>2</span>         7m <span class=c1># 2 分たってすべてが ready になる</span>
</pre></div> <h2 id=_3>参考<a class=headerlink href=#_3 title="Permanent link">#</a></h2> <ul> <li><a href=https://kubernetes.io/docs/concepts/workloads/pods/disruptions/ >Disruptions</a></li> <li><a href=https://kubernetes.io/docs/tasks/run-application/configure-pdb/ >Specifying a Disruption Budget for your Application</a></li> <li><a href=https://github.com/kubernetes/kubernetes/issues/12611>DisruptionBudget object to define the max disruption that can be caused to pods #12611</a></li> <li><a href=https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/ >Safely Drain a Node while Respecting Application SLOs</a></li> <li><a href=https://github.com/kubernetes/features/issues/85>PodDisruptionBudget and /eviction subresource #85</a></li> </ul> <hr> <div class=md-source-date> <small> 最後の更新: 47秒前 </small> </div> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2019 Masaki ISHIYAMA </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../assets/fonts/font-awesome.css> <a href=https://tellme.tokyo class="md-footer-social__link fa fa-globe"></a> <a href=https://github.com/b4b4r07 class="md-footer-social__link fa fa-github"></a> <a href=https://twitter.com/b4b4r07 class="md-footer-social__link fa fa-twitter"></a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.808e90bb.js></script> <script src=../../assets/javascripts/lunr/lunr.stemmer.support.js></script> <script src=../../assets/javascripts/lunr/tinyseg.js></script> <script src=../../assets/javascripts/lunr/lunr.ja.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> </body> </html>